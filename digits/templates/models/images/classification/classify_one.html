{# Copyright (c) 2014-2016, NVIDIA CORPORATION.  All rights reserved. #}
{% extends "job.html" %}

{% block nav %}
<li><a href="{{url_for('digits.model.views.show', job_id=model_job.id())}}">{{model_job.name()}}</a></li>
<li class="active"><a>Classify One</a></li>
{% endblock %}

{% block job_content %}

<script src="{{ url_for('static', filename='js/jquery.elevateZoom.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/underscore.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chroma.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/treeData.js') }}"></script>
<script src="{{ url_for('static', filename='js/dnnTree.js') }}"></script>



<div class="page-header">
    <h1>
        {{model_job.name()}}
        <small>
            {{model_job.job_type()}}
        </small>
    </h1>
</div>

<div class="row">
    {% if image_src %}
    <div class="col-sm-6">
        <img src="{{image_src}}" style="max-width:100%;" />
    </div>

    <div class="col-sm-6">
        <h4>Predictions</h4>
        <ul class="list-group">
            {% for label, confidence in predictions %}
            <li class="list-group-item">
            <span class="badge">{{confidence}}%</span>
            {{ label }}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <div class="alert alert-danger">
        <p>Classification failed, see job log</p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block job_content_details %}

<style>
.node {cursor: pointer;}
.overlay{background-color:#EEE;}
</style>



<script type="text/javascript">
    var charts = new Object();
    function drawHistogram(id, data) {
        charts[id] = c3.generate({
            bindto: id,
            size: {height: 200,width:200},
            data: {
                columns: [
                    ['Count'].concat(data[0]),
                    ['Value'].concat(data[1]),
                ],
                x: 'Value',
                type: 'area-spline',
            },
            axis: {
                x: {
                    label: {
                        text: 'Value',
                        position: 'outer-center',
                    },
                    tick: {
                        values: data[2],
                        format: d3.format('.3g'),
                    },
                    padding: {left: 0},
                },
                y: {
                    padding: {bottom: 0},
                },
            },
            bar: {
               width: {ratio: 0.2}
            },
            padding: {left: 20, right: 20},
            legend: {hide: true},
        });
    }

</script>
<style>
    div.histogram .c3-axis-y .tick {display: none;}
</style>

{% if visualizations %}

<script>

  function drawAlphaKernel(container,data){
    var h = w = 50;
    var grid_dim = Math.floor(Math.sqrt(data[0][0][0].length));
    var pixel_h = h/grid_dim;
    var pixel_w = w/grid_dim;

    var colormap = chroma.scale(['#541E8A','#3F84FE','#87BCFF','#4BD29F','#9AFFA2','#F3AC5A','#FF0000']).colors(255);
    // var colormap = chroma.scale(['#3277FF','#00B2FF','#1FDA9A','#FFE7A3','#DB3340']).colors(255);

    var neurons = _.flatten(_.flatten(data,true),true);

    _.each(neurons,function(n){
      var neuron = container.append("canvas")
        .attr({height:h, width:w, class: "panel panel-default"})
        .style({margin: "0px",height:h+"px", width:w+"px"});

      var ctx = neuron.node().getContext("2d");

      _.each(_.range(0,grid_dim),function(i){
        _.each(_.range(0,grid_dim),function(j){
          var x = j*pixel_w;
          var y = i*pixel_h;

          var c = 255*(Math.tanh(2*n[Math.floor(j)*grid_dim + i]));
          var rgb = colormap[Math.floor(c)];

          ctx.fillStyle = rgb;
          ctx.fillRect(x,y,pixel_w,pixel_h);
        });
      });
    });
  }

  function drawRGBKernel(container,data){
    var h = w = 50;
    var pixel_h = h/data[0].length;
    var pixel_w = w/data[0][0].length;

    _.each(data,function(item){
      var neuron = container.append("canvas")
        .attr({height:h, width:w})
        .attr("class","panel panel-default")
        .style({margin: "0px"})
        .style({height:h+"px", width:w+"px"});

      var ctx = neuron.node().getContext("2d");

      _.each(item,function(row,i){
          _.each(row,function(__,j){
            // Get Channels in RGB form ( 0 -> 255)
            var rgb = "rgb("+_.map(item[i][j],function(n){
              return Math.floor(n*255)
            }).join()+")";
            var x = j*pixel_w;
            var y = i*pixel_h;
            ctx.fillStyle = rgb;
            ctx.fillRect(x,y,pixel_w,pixel_h);
          });
      });
    });
  }


  function showLayer(layer){
    var name   = layer.name.replace("/","-");

    var container = d3.select("#layer-info")
     .style("text-align","center")
     .style("height","100px")
     .style("overflow-y","hidden")
     .html("");

     container.append("b").html(layer.name + " , " + layer.type);
     container.append("div")
      .attr("class","well")
      .style("height","70px")
      .style("overflow-y","auto")
      .html(layer.def);

      var panels = $(".row-"+name);
      if (panels.length < 1){
        name   = layer.top.replace("/","-").toLowerCase();
        panels = $(".row-"+name);
      }
      $(".row-vis").css("display","none");
      panels.css("display","block");
      $(".h3-vis").css("display","none");
      $(".h3-"+name+":first").css("display","block");

      // d3.json(base_url+"send_params")
      //     .post(JSON.stringify({
      //       image: {{image_data.tolist()}}
      //     }),
      //     function(error, data) {
      //       console.log(data);
      //     });


      d3.json(base_url+"visualize_features?job_id="+"{{request.args['job_id']}}")
        .post(JSON.stringify({
          layer_name: layer.name,
          image: {{image_data.tolist()}}
        }),
        function(error, json) {
          window.data = json;

          var container = d3.select("#layer-container")
            .html('')
            .style("line-height","1px")
            .style({height:"400px", width:"100%", background: "#f9f9f9", overflow: "auto"});

          if (json.weights[0][0][0].length == 3){
            drawRGBKernel(container,json.weights);
          }else {
            drawAlphaKernel(container,json.weights);
          }
      });

  }

  $(document).ready(function(){
    getTreeData('string','{{prototxt|tojson}}');
    loadTree('#tree-container',400);
    // loadTree('#treeLayout .panel',$(treeContainer.node()).height()/2);

    document.addEventListener("LayerClicked", function(e){
      // When a layer is clicked show panels with the same layer name or top
      showLayer(e.layer)
    });

    window.base_url = "http://localhost:5000/models/images/classification/";
    showLayer(_.filter(layers,function(d){return d.type == "Data"})[0]);
    console.log({{image_data.tolist()}});

  });
</script>

<div class="row">
  <div class="col-sm-6">
    <div id = "layer-info" class="panel panel-default"></div>
    <div id = "layer-container"></div>
    <br />
    <div id="tree-container"></div>
  </div>
  <div class="col-sm-6" style="display:inline-block;">
    <table class="table">
        <tr>
            <td><i>Totals</i></td>
            <td>
                <b>Total learned parameters:</b>
                {{'{:,}'.format(total_parameters)}}
            </td>
        </tr>
        {% for vis in visualizations %}

        {% set h3Class  = "h3-vis h3-"+vis['name'].replace('/','-') %}
        {% set rowClass = "row-vis row-"+vis['name'].replace('/','-') %}

        <!-- <h3 class="{{h3Class}}" style="display:none;">{{vis['name']}}</h3> -->
        <div class="{{rowClass}}" style="width:50%;float:left;display:none;">
          <div class="panel panel-default text-center" style="margin:1px;">
            <div>
                <p>
                {{vis['vis_type']}}
                {% if 'layer_type' in vis %}
                <small><i>({{vis['layer_type']}} layer)</i></small>
                {% endif %}
                </p>

                <p style="height:20px;">
                {% if 'param_count' in vis %}
                {{'{:,}'.format(vis['param_count'])}} learned parameters
                {% endif %}
                </p>

            </div>
            <div style="margin: 0 auto;min-height:200px;line-height:200px;">
                {% if vis['image_html'] %}
                <img style="width:200px;height:200px;" src="{{vis['image_html']}}" id="vis_{{ loop.index }}" />
                 <script>

                    $('#vis_{{ loop.index }}').elevateZoom({zoomType: "inner", cursor: "crosshair",
                            zoomWindowFadeIn: 500, zoomWindowFadeOut: 750,
                            scrollZoom: true, scrollZoomIncrement: 0.025});
                </script>
                {% else %}
                <i>Not shown</i>
                {% endif %}
            </div>
            <div>
                <b>Data shape:</b> {{vis['data_stats']['shape']}}<br>
                <b>Mean:</b> {{vis['data_stats']['mean']}}<br>
                <b>Std deviation:</b> {{vis['data_stats']['stddev']}}<br>
                <div id="histogram-{{loop.index}}" class="histogram"></div>
                <script>
                    drawHistogram("#histogram-{{loop.index}}", {{vis['data_stats']['histogram']}});
                </script>
            </div>
          </div>
        </div>

        {% endfor %}
    </table>
  </div>
</div>

{% endif %}

{% endblock %}
