{# Copyright (c) 2014-2016, NVIDIA CORPORATION.  All rights reserved. #}
{% extends "layout.html" %}

{% block head %}
<script src="{{ url_for('static', filename='js/underscore.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chroma.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/treeData.js') }}"></script>
<script src="{{ url_for('static', filename='js/dnnTree.js') }}"></script>
<script src="{{ url_for('static', filename='js/layer_visualization.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.form.min.js') }}"></script>
{% endblock %}


{% block nav %}
<li><a href="{{url_for('digits.model.views.show', job_id=model_job.id())}}">{{model_job.name()}}</a></li>
<li class="active"><a>Layer Visualizations</a></li>
{% endblock %}


{% block content %}

<style>
body , html, .container, .row {
  height: 100%;
}

.btn-file {
    position: relative;
    overflow: hidden;
}
.btn-file input[type=file] {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 100%;
    min-height: 100%;
    font-size: 200px;
    text-align: right;
    filter: alpha(opacity=0);
    opacity: 0;
    outline: none;
    background: white;
    cursor: inherit;
    display: block;
}

.fa-spin-custom, .glyphicon-spin {
  color:white;
  font-size: 40px;
  top: 50%;
  -webkit-animation: spin 1000ms infinite linear;
  animation: spin 1000ms infinite linear;
}

@-webkit-keyframes spin {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(359deg);
    transform: rotate(359deg);
  }
}

@keyframes spin {
    0% {
      -webkit-transform: rotate(0deg);
      transform: rotate(0deg);
    }
    100% {
      -webkit-transform: rotate(359deg);
      transform: rotate(359deg);
    }
}

@media (max-width: 768px){
  body {padding-top:250px;}
}
</style>

<script>

  window.prototxt = {{prototxt|tojson}};
  window.job_id   = '{{model_job.id()}}';
  window.base_url = "http://localhost:5000/models/images/classification/";
  window.pretrained = {{pretrained|tojson}}

  function showUploader(){
    // Setup model selector container:
    drawModelSelection('#selectModelLayout');
    // d3.select("#selectModelLayout").style("display","block");
  }

  function imageIsLoaded(e) {
    d3.select("#myImg")
      .attr("src", e.target.result)
      .style("display","block");

    var loadingLayout = drawLoadingContainer("#loadingLayout");

    $('#navigation').ajaxForm();
    $('#navigation').ajaxSubmit({
      url: window.base_url+"send_params?job_id={{model_job.id()}}&load_default="+window.load_default,
      success: function(json){
        loadingLayout.html('');
        window.conv1data = json.conv1
        window.outputs_data = json.data;
      }
    });
  };

  $(document).ready(function(){

    var navigation = d3.select("#navigation")
      .style({width: "200px", height: "100%",float: "left"});

    var file_selecion = navigation.append("div")
      .style({height: "50%", "padding-bottom": "10px"})
      .append("div")
        .attr("class", "panel panel-default text-center")
        .style({"padding-top": "10px", height: "100%", overflow: "hidden"});

    var model_visualizations = navigation.append("div")
      .style({height: "50%"})
      .append("div")
        .attr("class", "panel panel-default text-center")
        .style({"padding-top": "0px", height: "100%"});

    file_selecion.append("img")
      .attr({id: "myImg",src: "#", class: "panel panel-default"})
      .style({height: "130px", "margin": "0 auto 10px auto", "min-width": "100px", "max-width": "180px"});

    var inputContainer = file_selecion.append("span")
      .attr("class","btn btn-sm btn-primary btn-file")
      .style({display: "block", width: "150px", margin: "0 auto"});


    var listGroup = file_selecion.append("div")
      .style({
        margin: "20px auto 0px auto",
        "max-height": "127px",
        "overflow-y": "scroll",
        width: "230px",
        "border-bottom": "1px solid #eaeaea"
      });

    var listItemStyle = {
      width: "170px",
      position: "relative",
      left: "-7px",
      display: "block",
      margin: "0 auto",
      background: "none"
    };
    _.each(window.pretrained, function(item){
      listGroup.append("btn").attr("class","btn btn-sm btn-default")
      .style(listItemStyle).html(item.jobname);
    });
    _.each(_.range(0,4-window.pretrained.length), function(item){
      listGroup.append("btn")
      .attr("class","btn btn-sm btn-default")
      .attr("disabled","")
      .style(_.extend(_.clone(listItemStyle),{
        background: "#F3F3F3"
      }))
      .html("&nbsp;");
    });



    file_selecion.append("a")
      .attr("class","btn btn-default btn-sm")
      .style({position: "relative", top: "10px"})
      .on("click", showUploader)
      .html("Upload Pre-Trained Model");

    inputContainer.append("label")
      .style("margin-bottom","0px")
      .attr("for","image_file")
      .html("Select Image");

    inputContainer.append("input")
      .attr({type: "file", name: "image_file", id: "image_file"})
      .on("change", function(){
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = imageIsLoaded;
            reader.readAsDataURL(this.files[0]);
        }
    });

    model_visualizations.append("div").attr("id", "locked_backprop_container")
        .attr({class: "panel panel-default"})
        .style({height: "180px", width: "180px", display: "none", margin: "5px auto"});

    model_visualizations.append("div").attr("id", "backprop_layer");
    model_visualizations.append("div").attr("id", "backprop_output");

    var visualizations = d3.select("#layerLayout").append("div")
      .attr("class", "panel panel-default")
      .style({height: "100%", "text-align":"center", width: "220px", float: "right", "margin-left": "10px"});

    visualizations.append("canvas").attr("id", "neuron_visualization")
        .attr({height: "180px", width: "180px", class: "panel panel-default"})
        .style({position: "relative", top: "15px"});

    visualizations.append("div").attr("id","deconv_container")
        .attr("class", "panel panel-default")
        .style({height: "180px", width: "180px", margin: "0 auto"});

    init_vis('{{prototxt|tojson}}');

  });


</script>

  <div class="row" style="display:inline;">

    <form id="navigation" name="navigation" method="post" enctype="multipart/form-data"></form>
    <div id="treeLayout"></div>
    <div id="layerLayout"></div>
    <div id="loadingLayout"></div>
    <form id="selectModelLayout" name="selectModel" method="post" enctype="multipart/form-data"></form>
    <div style="clear: both;"></div>
  </div>


{% endblock %}
