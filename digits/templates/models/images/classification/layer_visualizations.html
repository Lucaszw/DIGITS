{# Copyright (c) 2014-2016, NVIDIA CORPORATION.  All rights reserved. #}
{% extends "layout.html" %}

{% block head %}
<script src="{{ url_for('static', filename='js/underscore.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chroma.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/treeData.js') }}"></script>
<script src="{{ url_for('static', filename='js/dnnTree.js') }}"></script>
<script src="{{ url_for('static', filename='js/layer_visualization.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.form.min.js') }}"></script>
{% endblock %}


{% block nav %}
<li><a href="{{url_for('digits.model.views.show', job_id=model_job.id())}}">{{model_job.name()}}</a></li>
<li class="active"><a>Layer Visualizations</a></li>
{% endblock %}


{% block content %}

<style>
body , html, .container, .row {
  height: 100%;
}

.btn-file {
    position: relative;
    overflow: hidden;
}
.btn-file input[type=file] {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 100%;
    min-height: 100%;
    font-size: 100px;
    text-align: right;
    filter: alpha(opacity=0);
    opacity: 0;
    outline: none;
    background: white;
    cursor: inherit;
    display: block;
}

.fa-spin-custom, .glyphicon-spin {
  color:white;
  font-size: 40px;
  top: 50%;
  -webkit-animation: spin 1000ms infinite linear;
  animation: spin 1000ms infinite linear;
}

@-webkit-keyframes spin {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(359deg);
    transform: rotate(359deg);
  }
}

@keyframes spin {
    0% {
      -webkit-transform: rotate(0deg);
      transform: rotate(0deg);
    }
    100% {
      -webkit-transform: rotate(359deg);
      transform: rotate(359deg);
    }
}

@media (max-width: 768px){
  body {padding-top:250px;}
}
</style>

<script>

  window.prototxt = {{prototxt|tojson}};
  window.job_id   = '{{model_job.id()}}';
  window.base_url = "http://localhost:5000/models/images/classification/";

  function showUploader(){
    d3.select("#selectModelLayout").style("display","block");
  }

  function imageIsLoaded(e) {
    d3.select("#myImg")
      .attr("src", e.target.result)
      .style("display","block");

    d3.select("#loadingLayout").style("display","block");

    $('#navigation').ajaxForm();
    $('#navigation').ajaxSubmit({
      url: window.base_url+"send_params?job_id={{model_job.id()}}&load_default="+window.load_default,
      success: function(json){
        d3.select("#loadingLayout").style("display","none");

        window.conv1data = json.conv1
        window.outputs_data = json.data;
        console.log("Outputs Loaded!");
      }
    });

  };


  $(document).ready(function(){

    var navigation = d3.select("#navigation")
      .style({width: "200px", height: "100%",float: "left"})
      .append("div")
        .attr("class", "panel panel-default text-center")
        .style({"padding-top": "10px", height: "100%"});

    navigation.append("img")
      .attr({id: "myImg",src: "#", class: "panel panel-default"})
      .style({width: "180px", "margin-left": "10px", "max-height": "200px", display: "none"});

    var inputContainer = navigation.append("span")
      .attr("class","btn btn-sm btn-primary btn-file");

    navigation.append("a")
      .attr("class","btn btn-default btn-sm")
      .style({position: "relative", top: "10px"})
      .on("click", showUploader)
      .html("Upload Pre-Trained Model");

    inputContainer.append("label")
      .style("margin-bottom","0px")
      .attr("for","image_file")
      .html("Select Image");

    inputContainer.append("input")
      .attr({type: "file", name: "image_file", id: "image_file"})
      .on("change", function(){
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = imageIsLoaded;
            reader.readAsDataURL(this.files[0]);
        }
      });

    init_vis('{{prototxt|tojson}}');

  });


</script>

  <div class="row" style="display:inline;">

    <form id="navigation" name="navigation" method="post" enctype="multipart/form-data"></form>
    <div id="treeLayout"></div>
    <div id="layerLayout"></div>
    <div id="loadingLayout"><span class="glyphicon glyphicon-refresh glyphicon-spin"></span></div>
    <form id="selectModelLayout" name="selectModel" method="post" enctype="multipart/form-data"></form>
    <div style="clear: both;"></div>
  </div>


{% endblock %}
